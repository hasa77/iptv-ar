name: IPTV Middleware

on:
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 03:00 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Python deps
        run: pip install requests lxml

      - name: Download IPTV playlist
        run: |
          curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" -e "https://iptv-org.github.io/" https://iptv-org.github.io/iptv/languages/ara.m3u -o raw.m3u

      - name: Download Official Arabic EPG
        run: curl -L https://raw.githubusercontent.com/iptv-org/epg/master/guides/arabic.xml -o raw.xml

      - name: Process playlist and EPG
        run: |
          python << 'EOF'
          import requests
          import re
          from lxml import etree

          # Load playlist
          with open("raw.m3u", "r", encoding="utf-8", errors="ignore") as f:
              lines = f.readlines()

          cleaned = []
          kept_ids = set()
          i = 0

          while i < len(lines):
              line = lines[i]
              if line.startswith("#EXTINF") and i+1 < len(lines):
                  info = line
                  url = lines[i+1].strip()

                  # Remove Iran/Afghanistan channels
                  if '/ir.' in url or '/af.' in url:
                      i += 2
                      continue

                  # Basic stream check using headers
                  headers = {
                      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0 Safari/537.36",
                      "Referer": url
                  }
                  try:
                      r = requests.get(url, headers=headers, timeout=5, stream=True)
                      if r.status_code >= 400:
                          i += 2
                          continue
                  except:
                      i += 2
                      continue

                  # Keep channel
                  cleaned.append(info)
                  cleaned.append(url + "\n")

                  # Save tvg-id
                  match = re.search(r'tvg-id="([^"]+)"', info)
                  if match:
                      kept_ids.add(match.group(1))

                  i += 2
              else:
                  i += 1

          with open("arabic-clean.m3u", "w", encoding="utf-8") as f:
              f.writelines(cleaned)

          # Trim XMLTV EPG
          try:
              tree = etree.parse("raw.xml")
              root = tree.getroot()

              # Keep only channels we kept
              for channel in list(root.findall("channel")):
                  if channel.attrib.get("id") not in kept_ids:
                      root.remove(channel)

              # Keep only programmes of kept channels
              for programme in list(root.findall("programme")):
                  if programme.attrib.get("channel") not in kept_ids:
                      root.remove(programme)

              tree.write("arabic-epg-clean.xml", encoding="utf-8", xml_declaration=True)
          except Exception as e:
              print("XML processing failed:", e)

          EOF

      - name: Commit results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add arabic-clean.m3u arabic-epg-clean.xml
          git commit -m "Auto update IPTV middleware" || echo "No changes"
          git push
